#!/bin/bash

# This script was developed by 
# Estonia Team at La Senia 
# 2016

# Some documentations remains here.
# TODO


# SANITY CHECKS
#

# Permissions

# Some values
DEFAULTMODE=""
ONLYNAME=""

if [ $(id -u) -ne 0 ]; then
	echo " [ ERROR ]: You need execution privileges to run this program"
	echo " [ YOU SHALL NOT PASS! ]"
	echo " Please run : "
	echo " sudo $(basename $0)"
	exit 1
fi

# Test arguments

if [ $# -eq 0 -o $# -gt 2 ] ; then
	echo " [ USAGE ] : "
	echo " - set IP-NEW-GW"
	echo " - delete"
	exit 1
fi

ACTION="${1}"
MYIP="$2"
if [ "${ACTION}" = "set" ]; then

    # Would be a good idea test if IP and names are in 
    # corrects forms.
    TPL_PATH="/usr/share/senia/firstboot/templates"
    TPL_NETPLAN_GW="$TPL_PATH/netplan-gw.tpl"

    IFACE=$(ip addr | grep ^2 | cut -d " " -f2 | tr ":" " "| sed -e "s/ //g")

	echo " * Setting IP on netplan"
	sed -e "s/_@_IFACE_@_/$IFACE/g;s/_@_MYIP_@_/$MYIP/g" "$TPL_NETPLAN_GW" > /etc/netplan/03-senia-gateway.yaml

    netplan apply

elif [ "${ACTION}" = "delete" ]; then
    
    echo " * Cleaning configuration "
    rm -f /etc/netplan/03-senia-gateway.yaml
    netplan apply

fi

exit 0
