#!/bin/bash

CHANNEL="xfce4-desktop"
DEFAULT_PROP_WALL_VALUE="/usr/share/senia/pixmaps/backgrounds/senia-wallpaper-current.png"
PROP_WALL=""

# Test if this machine is a Senia Sacred Place
rc=0
senia-version -t sacred || rc=1
if [ $rc -eq 0 ]; then
	logger -t "senia-stasi" -s " $(basename $0) -> This is a Sacred Place, nothing to do"
	exit 0
fi


rc=0
xfconf-query -c ${CHANNEL} -l | grep -q last-image  || rc=1

if [ ${rc} -eq 1 ]; then
	echo " * Nothing has changed "
	exit 0
else
	PROP_WALL=$(xfconf-query -c ${CHANNEL} -l | grep last-image | tr "\n" " ")
	for prop in ${PROP_WALL}; do
		# Test if the property has changed 
		aux=$(xfconf-query -c xfce4-desktop  -p ${prop})
		if [ "${aux}" != "${DEFAULT_PROP_WALL_VALUE}" ]; then
			CURRENT_WALL=$(echo ${prop} | grep last-image | cut -d '/' -f 4,5 )
			MSG=" * Setting the correct wallpaper for user ${USER} : ${CURRENT_WALL} "
			logger -t "senia-stasi" -s "${MSG}"
			xfconf-query -c "${CHANNEL}" -p "${prop}" -s "${DEFAULT_PROP_WALL_VALUE}" --create
		else
			logger -t "senia-stasi" -s "Nothing to see here"
		fi
	done
fi

exit 0
